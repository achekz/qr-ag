{% extends "base.html" %}

{% block title %}Admin - AGA QR Code System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-cog me-2"></i>Admin Panel</h2>
            <button class="btn btn-primary" onclick="loadMembers()">
                <i class="fas fa-upload me-2"></i>Load Members from CSV
            </button>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>Members List
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="loading" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading members...</p>
                        </div>

                        <div id="members-container">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-users fa-3x mb-3"></i>
                                <p>No members loaded yet. Click "Load Members from CSV" to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h3 class="text-primary" id="total-members">0</h3>
                                <p class="text-muted mb-0">Total Members</p>
                            </div>
                            <div class="col-6">
                                <h3 class="text-success" id="checked-in">0</h3>
                                <p class="text-muted mb-0">Checked In</p>
                            </div>
                        </div>
                        <hr>
                        <div class="d-grid">
                            <button class="btn btn-success" onclick="sendInvitations()">
                                <i class="fas fa-envelope me-2"></i>Send Invitations
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Instructions
                        </h5>
                    </div>
                    <div class="card-body">
                        <ol class="small">
                            <li>Ensure your CSV file (2025_TIPCS_Annual_General_Assembly_(AGA25).csv) is in the project directory</li>
                            <li>Click "Load Members from CSV" to import data</li>
                            <li>QR codes will be generated automatically</li>
                            <li>Use "Send Invitations" to distribute QR codes</li>
                            <li>Monitor attendance in real-time</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="qr-image" src="" alt="QR Code" class="img-fluid">
                <p class="mt-3" id="qr-member-name"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadQR()">
                    <i class="fas fa-download me-2"></i>Download
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let members = [];

function loadMembers() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('members-container');
    
    loading.style.display = 'block';
    container.innerHTML = '';

    fetch('/api/load-members', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';
        
        if (data.success) {
            showAlert('success', data.message);
            loadMembersList();
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        loading.style.display = 'none';
        showAlert('danger', 'Error loading members: ' + error.message);
    });
}

function loadMembersList() {
    fetch('/api/members')
    .then(response => response.json())
    .then(data => {
        members = data;
        displayMembers(data);
        updateStatistics(data);
    })
    .catch(error => {
        showAlert('danger', 'Error loading members list: ' + error.message);
    });
}

function displayMembers(membersData) {
    const container = document.getElementById('members-container');
    
    if (membersData.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-users fa-3x mb-3"></i>
                <p>No members found.</p>
            </div>
        `;
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;

    membersData.forEach(member => {
        const statusBadge = member.checked_in 
            ? '<span class="badge bg-success">Checked In</span>'
            : '<span class="badge bg-secondary">Not Checked In</span>';
        
        const checkInTime = member.check_in_time 
            ? `<small class="text-muted d-block">${new Date(member.check_in_time).toLocaleString()}</small>`
            : '';

        html += `
            <tr>
                <td>${member.full_name}</td>
                <td>${member.email}</td>
                <td>${member.phone}</td>
                <td>${statusBadge}${checkInTime}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showQR('${member.member_id}', '${member.full_name}')">
                        <i class="fas fa-qrcode"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function updateStatistics(membersData) {
    const total = membersData.length;
    const checkedIn = membersData.filter(m => m.checked_in).length;
    
    document.getElementById('total-members').textContent = total;
    document.getElementById('checked-in').textContent = checkedIn;
}

function showQR(memberId, memberName) {
    const qrImage = document.getElementById('qr-image');
    const qrMemberName = document.getElementById('qr-member-name');
    
    qrImage.src = `/api/generate-qr/${memberId}`;
    qrMemberName.textContent = memberName;
    
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
}

function downloadQR() {
    const qrImage = document.getElementById('qr-image');
    const link = document.createElement('a');
    link.href = qrImage.src;
    link.download = `qr-code-${document.getElementById('qr-member-name').textContent.replace(/\s+/g, '-')}.png`;
    link.click();
}

function sendInvitations() {
    const selectedMembers = members.filter(m => !m.checked_in);
    
    if (selectedMembers.length === 0) {
        showAlert('warning', 'No members available to send invitations to.');
        return;
    }

    fetch('/api/send-invitations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ members: selectedMembers })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error sending invitations: ' + error.message);
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Load members list on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMembersList();
});
</script>
{% endblock %}

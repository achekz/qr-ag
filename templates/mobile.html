<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGA Verification - Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .verification-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .result-valid {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        .result-invalid {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }
        .qr-input {
            font-size: 18px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }
        .qr-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .scan-button {
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            font-weight: bold;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .member-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            font-size: 0.9em;
            padding: 8px 12px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid px-3 py-4">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-6 text-primary">
                <i class="fas fa-qrcode"></i> AGA Verification
            </h1>
            <p class="text-muted">Scan QR codes to verify attendance</p>
        </div>

        <!-- Main Verification Card -->
        <div class="card verification-card mb-4">
            <div class="card-body p-4">
                <h5 class="card-title text-center mb-4">
                    <i class="fas fa-search me-2"></i>QR Code Verification
                </h5>
                
                <div class="mb-3">
                    <label for="qr-input" class="form-label fw-bold">Enter QR Code Data:</label>
                    <input type="text" class="form-control qr-input" id="qr-input" 
                           placeholder="Scan or manually enter QR code data">
                </div>
                
                <button class="btn btn-primary w-100 scan-button" onclick="verifyQR()">
                    <i class="fas fa-check-circle me-2"></i>Verify QR Code
                </button>
                
                <div id="verification-result" class="mt-4" style="display: none;">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-6">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h3 class="mb-1" id="total-members">0</h3>
                        <p class="mb-0">Total Members</p>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h3 class="mb-1" id="checked-in">0</h3>
                        <p class="mb-0">Checked In</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Check-ins -->
        <div class="card member-card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Recent Check-ins
                </h6>
            </div>
            <div class="card-body p-3">
                <div id="recent-checkins">
                    <p class="text-muted text-center mb-0">No recent check-ins</p>
                </div>
            </div>
        </div>

        <!-- All Members Status -->
        <div class="card member-card">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-users me-2"></i>All Members
                </h6>
            </div>
            <div class="card-body p-0">
                <div id="members-list">
                    <div class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading members...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let recentCheckins = [];

        function verifyQR() {
            const qrInput = document.getElementById('qr-input');
            const qrData = qrInput.value.trim();
            
            if (!qrData) {
                showToast('warning', 'Please enter QR code data');
                return;
            }

            fetch('/api/verify-qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ qr_data: qrData })
            })
            .then(response => response.json())
            .then(data => {
                displayVerificationResult(data);
                if (data.valid) {
                    qrInput.value = '';
                    addToRecentCheckins(data);
                    updateStatistics();
                }
            })
            .catch(error => {
                showToast('danger', 'Error verifying QR code: ' + error.message);
            });
        }

        function displayVerificationResult(data) {
            const resultDiv = document.getElementById('verification-result');
            const className = data.valid ? 'result-valid' : 'result-invalid';
            
            resultDiv.innerHTML = `
                <div class="card ${className}">
                    <div class="card-body text-center">
                        <i class="fas fa-${data.valid ? 'check-circle' : 'times-circle'} fa-2x mb-3"></i>
                        <h5 class="mb-2">${data.message}</h5>
                        ${data.member_name ? `<p class="mb-1"><strong>Member:</strong> ${data.member_name}</p>` : ''}
                        ${data.check_in_time ? `<p class="mb-0"><strong>Time:</strong> ${data.check_in_time}</p>` : ''}
                    </div>
                </div>
            `;
            
            resultDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        function addToRecentCheckins(data) {
            if (data.valid) {
                recentCheckins.unshift({
                    name: data.member_name,
                    time: data.check_in_time || new Date().toLocaleString()
                });
                
                // Keep only last 5
                if (recentCheckins.length > 5) {
                    recentCheckins = recentCheckins.slice(0, 5);
                }
                
                updateRecentCheckins();
            }
        }

        function updateRecentCheckins() {
            const container = document.getElementById('recent-checkins');
            
            if (recentCheckins.length === 0) {
                container.innerHTML = '<p class="text-muted text-center mb-0">No recent check-ins</p>';
                return;
            }
            
            let html = '';
            recentCheckins.forEach(checkin => {
                html += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <strong>${checkin.name}</strong>
                        </div>
                        <small class="text-muted">${checkin.time}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateStatistics() {
            fetch('/api/members')
            .then(response => response.json())
            .then(members => {
                const total = members.length;
                const checkedIn = members.filter(m => m.checked_in).length;
                
                document.getElementById('total-members').textContent = total;
                document.getElementById('checked-in').textContent = checkedIn;
                
                // Update members list
                updateMembersList(members);
            })
            .catch(error => {
                console.error('Error updating statistics:', error);
            });
        }

        function updateMembersList(members) {
            const container = document.getElementById('members-list');
            
            if (members.length === 0) {
                container.innerHTML = '<div class="text-center p-3"><p class="text-muted mb-0">No members found</p></div>';
                return;
            }
            
            let html = '';
            members.forEach(member => {
                const statusBadge = member.checked_in 
                    ? '<span class="badge bg-success status-badge">Checked In</span>'
                    : '<span class="badge bg-secondary status-badge">Not Checked In</span>';
                
                const checkInTime = member.check_in_time 
                    ? new Date(member.check_in_time).toLocaleString()
                    : '-';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-3 px-3">
                        <div>
                            <div class="fw-bold">${member.full_name}</div>
                            <small class="text-muted">${checkInTime}</small>
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showToast(type, message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            const toastInstance = new bootstrap.Toast(toast);
            toastInstance.show();
        }

        // Allow Enter key to verify QR code
        document.getElementById('qr-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyQR();
            }
        });

        // Update statistics on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateStatistics();
            
            // Update every 30 seconds
            setInterval(updateStatistics, 30000);
        });
    </script>
</body>
</html>
